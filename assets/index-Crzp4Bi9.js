(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))r(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function a(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(e){if(e.ep)return;e.ep=!0;const n=a(e);fetch(e.href,n)}})();class p{grayscale(t){for(let a=0;a<t.data.length;a+=4){const r=t.data[a]*.299+t.data[a+1]*.587+t.data[a+2]*.114;t.data.fill(r,a,a+3)}return t}threshold(t,a){for(let r=0;r<t.data.length;r+=4){const n=t.data[r]*.299+t.data[r+1]*.587+t.data[r+2]*.114<a?0:255;t.data.fill(n,r,r+3)}return t}bayer(t,a){const r=[[15,135,45,165],[195,75,225,105],[60,180,30,150],[240,120,210,90]];for(let e=0;e<t.data.length;e+=4){const n=t.data[e]*.299+t.data[e+1]*.587+t.data[e+2]*.114,o=e/4%t.width,i=Math.floor(e/4/t.width),s=Math.floor((n+r[o%4][i%4])/2)<a?0:255;t.data.fill(s,e,e+3)}return t}floydsteinberg(t){const a=t.width,r=new Uint8ClampedArray(t.width*t.height);for(let e=0,n=0;n<t.data.length;e++,n+=4)r[e]=t.data[n]*.299+t.data[n+1]*.587+t.data[n+2]*.114;for(let e=0,n=0;n<t.data.length;e++,n+=4){const o=r[e]<129?0:255,i=Math.floor((r[e]-o)/16);t.data.fill(o,n,n+3),r[e+1]+=i*7,r[e+a-1]+=i*3,r[e+a]+=i*5,r[e+a+1]+=i*1}return t}atkinson(t){const a=t.width,r=new Uint8ClampedArray(t.width*t.height);for(let e=0,n=0;n<t.data.length;e++,n+=4)r[e]=t.data[n]*.299+t.data[n+1]*.587+t.data[n+2]*.114;for(let e=0,n=0;n<t.data.length;e++,n+=4){const o=r[e]<129?0:255,i=Math.floor((r[e]-o)/8);t.data.fill(o,n,n+3),r[e+1]+=i,r[e+2]+=i,r[e+a-1]+=i,r[e+a]+=i,r[e+a+1]+=i,r[e+2*a]+=i}return t}}const h=576,w=27,g=29,y=31;document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("imgFile"),t=document.getElementById("myCanvas"),a=document.getElementById("printBtn"),r=t.getContext("2d");r&&(l.addEventListener("change",async e=>{var f;const n=(f=e.target.files)==null?void 0:f[0];if(!n)return;const o=await b(n),i=o.height/o.width,c=Math.round(h*i);t.width=h,t.height=c,r.drawImage(o,0,0,h,c);const s=r.getImageData(0,0,h,c),d=I(s);r.putImageData(d,0,0);const u=new p().floydsteinberg(d);r.putImageData(u,0,0)}),a.addEventListener("click",async()=>{let e=null,n=null,o=null;if(!navigator.serial){alert("Web Serial APIがサポートされていません。");return}try{if(e=await navigator.serial.requestPort(),await e.open({baudRate:115200}),n=e.writable.getWriter(),!n)return;await n.write(new Uint8Array([w,64])),await n.write(new Uint8Array([w,97,1])),await n.write(new Uint8Array([y,17,55,150])),await n.write(new Uint8Array([y,17,2,1]));let i=0;for(;;){const s=r.getImageData(0,0,h,t.height),d=v(s,i);if(!d)break;const u=h/8,f=d.length/u;await n.write(new Uint8Array([g,118,48,0])),await n.write(new Uint8Array([u&255,u>>8&255])),await n.write(new Uint8Array([f&255,f>>8&255])),await n.write(d),i+=f+1}await n.write(new Uint8Array([w,100,3])),await n.write(new Uint8Array([y,17,14])),o=e.readable.getReader();let c=-1;for(;c!==0;){const{value:s,done:d}=await o.read();if(d){console.warn("プリンターからの読み取りが完了しました。印字完了を確認できませんでした。");break}c=s[2],console.log("device timer:",c)}console.log("印刷が完了しました！")}catch(i){console.error("Error:",i)}finally{n&&n.releaseLock(),o&&o.releaseLock(),e&&await e.close()}}))});function I(l){const t=l.data;for(let a=0;a<t.length;a+=4){const r=t[a],e=t[a+1],n=t[a+2],o=.299*r+.587*e+.114*n;t[a]=t[a+1]=t[a+2]=o}return l}function b(l){return new Promise((t,a)=>{const r=new Image;r.onload=()=>t(r),r.onerror=a,r.src=URL.createObjectURL(l)})}function v(l,t){const a=l.width,r=Math.min(255,l.height-t);if(r<=0)return null;const e=l.data,n=new Uint8Array(a*r/8);for(let o=0;o<r;o++)for(let i=0;i<a;i++){const c=((t+o)*a+i)*4,s=o*a+i,d=Math.floor(s/8),u=s%8;e[c]<128&&(n[d]|=1<<7-u)}return n}
